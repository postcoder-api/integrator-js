function _classCallCheck(a, n) {
  if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function");
}
function _createClass(e, r, t) {
  return Object.defineProperty(e, "prototype", {
    writable: false
  }), e;
}

function selectSuggestion(target){var dataTypeAttribute=target.getAttribute("data-type");var dataIdAttribute=target.getAttribute("data-id");if(dataIdAttribute==null)return;if(dataTypeAttribute==="BACK"){this.data.facetselected=false;this.data.pathfilter="";getSuggestions.call(this);}else if(dataTypeAttribute==="ADD"){retrieve.call(this,dataIdAttribute);}else {this.data.pathfilter=dataIdAttribute.toString();this.data.facetselected=true;getSuggestions.call(this);}}function showSuggestions(){if(!this.data.suggestionlist){return}this.data.suggestionlist.style.display="block";if(this.data.suggestions.length===0){var option=document.createElement("li");option.classList.add("postcoder-suggestion");option.classList.add("postcoder-no-results");option.innerHTML=this.data.no_results_message;this.data.suggestionlist.appendChild(option);this.data.facetselected=false;this.data.pathfilter="";}else {for(var i=0;i<this.data.suggestions.length;i++){var _option=document.createElement("li");_option.classList.add("postcoder-suggestion");var suggestiontext="";suggestiontext=this.data.suggestions[i].summaryline;if(this.data.suggestions[i].count>1){var count=this.data.suggestions[i].count>100?"100+":this.data.suggestions[i].count;suggestiontext+=" <span class=\"postcoder-extra-info\">("+count+" addresses)</span>";}_option.innerHTML=suggestiontext;_option.setAttribute("data-id",this.data.suggestions[i].id);_option.setAttribute("data-type",this.data.suggestions[i].type);this.data.suggestionlist.appendChild(_option);}if(this.data.facetselected){var backOption=this.data.suggestionlist.querySelector("li[data-type=\"BACK\"]");if(backOption){return}else {var _option2=document.createElement("li");_option2.classList.add("postcoder-suggestion");_option2.classList.add("postcoder-facet-back");_option2.innerHTML="\u21A9 Back";_option2.setAttribute("data-type","BACK");_option2.setAttribute("data-id","0");this.data.suggestionlist.insertBefore(_option2,this.data.suggestionlist.firstChild);}}}}function retrieve(id){var _this=this;var country=getCountry.call(this);var url=this.data.retrieveEndpoint+"?apikey="+this.data.apikey+"&country="+country+"&query="+this.data.searchterm+"&id="+id+"&lines="+this.data.addresslines+"&identifier="+encodeURIComponent(this.data.config.identifier)+"&exclude="+excludeFields.call(this);fetch(url).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(addresses){processResult.call(_this,addresses[0]);})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});}function getSuggestions(){var _this2=this;this.data.searchterm=encodeURIComponent(this.data.input.value.trim());if(this.data.searchterm===""){newSuggestionsReset.call(this);return}if(this.data.searchterm.length<3){hideSuggestions.call(this);return}var url=this.data.suggestionEndpoint+"?apikey="+this.data.apikey+"&country="+getCountry.call(this)+"&singlesummary=true"+"&query="+this.data.searchterm;if(this.data.pathfilter){url+="&pathfilter="+encodeURIComponent(this.data.pathfilter);}if(this.data.config.usercategory){url+="&usercategory="+this.data.config.usercategory;}if(this.data.config.postcode){url+="&postcode="+this.data.config.postcode;}if(this.data.config.enablefacets){url+="&enablefacets="+this.data.config.enablefacets;}if(this.data.config.maximumresults){url+="&maximumresults="+this.data.config.maximumresults;}this.data.abortController=new AbortController;fetch(url,{signal:this.data.abortController.signal}).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(json){newSuggestionsReset.call(_this2);_this2.data.suggestions=json;showSuggestions.call(_this2);})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});}function hideSuggestions(){if(!this.data.suggestionlist)return;this.data.suggestionlist.innerHTML="";this.data.suggestionlist.style.display="none";}function newSuggestionsReset(){hideSuggestions.call(this);this.data.pathfilter="";this.data.suggestions=[];this.data.suggestionlist.scrollTop=0;this.data.selectedIndex=-1;}function getCountry(){return typeof this.data.config.countrycode!=="undefined"&&this.data.config.countrycode!==""?this.data.config.countrycode:this.data.countrySelectorElement.value}function processResult(address){hideSuggestions.call(this);this.data.facetselected=false;newSuggestionsReset.call(this);var possibleFields=["organisation","addressline1","addressline2","addressline3","addressline4","addressline5","addressline6","addressline7","addressline8","addressline9","posttown","county","postcode"];for(var i=0;i<possibleFields.length;i++){var field_selector=this.data.config.outputfields[possibleFields[i]];if(typeof field_selector=="string"&&field_selector!==""){var element=document.querySelector(field_selector);if(element instanceof HTMLInputElement){element.value=typeof address[possibleFields[i]]!=="undefined"?address[possibleFields[i]]:"";}}}}function excludeFields(){var organisationField=this.data.config.outputfields["organisation"];if(organisationField===""||organisationField===undefined){return "posttown,county,postcode,country"}else {return "organisation,posttown,county,postcode,country"}}

function suggestionClick(event){event.stopPropagation();if(event.target==null||!(event.target instanceof Element)){return}var target=event.target;while(target.tagName.toLowerCase()!=="li"){if(target.parentNode!=null&&target.parentNode instanceof Element){target=target.parentNode;}}selectSuggestion.call(this,target);}function documentClick(event){if(!event.target)return;if(this.data.suggestionlist.contains(event.target)||this.data.input.contains(event.target)){return}hideSuggestions.call(this);}function keydown(event){if(!this.data.suggestionlist)return;var key=event.key;switch(key){case "Up":case "Down":case "ArrowUp":case "ArrowDown":{var selectedIndex=key==="ArrowUp"||key==="Up"?this.data.selectedIndex-1:this.data.selectedIndex+1;event.preventDefault();arrows.call(this,selectedIndex);break}case "Tab":{tab.call(this,event);break}case "Enter":{selectSuggestion.call(this,this.data.suggestionlist.querySelectorAll("li")[this.data.selectedIndex]);break}case "Esc":case "Escape":{hideSuggestions.call(this);break}default:this.data.facetselected=false;this.data.pathfilter="";return}}function arrows(selectedIndex){if(!this.data.suggestionlist)return;var suggestionsCount=this.data.suggestions.length;if(this.data.facetselected){suggestionsCount++;}if(this.data.suggestionlist.querySelectorAll("li").length>0){if(this.data.selectedIndex>=0){this.data.suggestionlist.querySelectorAll("li")[this.data.selectedIndex].classList.remove("selected");}this.data.selectedIndex=(selectedIndex%suggestionsCount+suggestionsCount)%suggestionsCount;this.data.suggestionlist.querySelectorAll("li")[this.data.selectedIndex].classList.add("selected");this.data.suggestionlist.querySelectorAll("li")[this.data.selectedIndex].scrollIntoView(false);}}function tab(event){if(this.data.selectedIndex>=0){event.preventDefault();selectSuggestion.call(this,this.data.suggestionlist.querySelectorAll("li")[this.data.selectedIndex]);}else {hideSuggestions.call(this);}}function input(){var _this=this;clearTimeout(this.data.debounce);if(this.data.abortController!==null){this.data.abortController.abort("Aborted a request to Postcoder because new input was detected.");}this.data.debounce=setTimeout(function(){return getSuggestions.call(_this)},this.data.inputdelay);}function focus(){if(this.data.suggestions.length>0){showSuggestions.call(this);}else {getSuggestions.call(this);}}

var defaultConfig={apikey:"",searchinput:"",outputfields:{addressline1:""},defaultstyles:true,geolocate:false,identifier:"Postcoder Integrator"};var initialData={abortController:null,addresslines:0,apikey:"",config:Object.assign({},defaultConfig),countrySelectorElement:null,debounce:0,facetselected:false,input:null,inputdelay:50,no_results_message:"No addresses found",pathfilter:"",retrieveEndpoint:"https://ws.postcoder.com/pcw/autocomplete/retrieve",searchinput:"",searchterm:"",selectedIndex:-1,suggestionEndpoint:"https://ws.postcoder.com/pcw/autocomplete/find",suggestionlist:null,suggestions:[]};

var defaultStyles = ".postcoder-wrapper{position:relative;width:100%;}.postcoder-wrapper input.postcoder-input{width:100%;}.postcoder-wrapper ul.postcoder-suggestions-list{position:absolute;background-color:white;border:1px solid #ccc;padding:0;max-height:400px;overflow-y:auto;width:100%;z-index:1000;margin:0;display:none;list-style-type:none;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion{cursor:pointer;padding:0.5rem 1rem;}.postcoder-wrapper\rul.postcoder-suggestions-list\rli.postcoder-suggestion.selected{background-color:bisque;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion:hover{background-color:#ddd;}.postcoder-wrapper ul.postcoder-suggestions-list .postcoder-extra-info{font-size:0.8rem;color:#666;}.postcoder-wrapper ul.postcoder-suggestions-list .postcoder-facet-back{font-weight:bold;}";

var PostcoderAddressAutocomplete=_createClass(function PostcoderAddressAutocomplete(config){var _this=this;_classCallCheck(this,PostcoderAddressAutocomplete);this.setupSuggestionsList=function(){if(!_this.data.input)return;var suggestionsElement=document.createElement("ul");suggestionsElement.id="postcoder-suggestions-list-"+_this.data.config.searchinput;suggestionsElement.classList.add("postcoder-suggestions-list");suggestionsElement.addEventListener("click",function(e){return suggestionClick.call(_this,e)});var wrapper=document.createElement("div");wrapper.classList.add("postcoder-wrapper");_this.data.input.parentNode.insertBefore(wrapper,_this.data.input.nextSibling);wrapper.appendChild(_this.data.input);wrapper.appendChild(suggestionsElement);document.body.addEventListener("click",function(e){return documentClick.call(_this,e)});_this.data.suggestionlist=suggestionsElement;};this.data=structuredClone(initialData);var mergedConfigs=Object.assign(Object.assign({},this.data.config),config);this.data.config=mergedConfigs;this.data.abortController=null;if(this.data.config.apikey){this.data.apikey=this.data.config.apikey;}else {throw new Error("Postcoder Autocomplete: No API key provided. This is required for address lookup to function. Sign up for a free trial at https://postcoder.com")}if(this.data.config.defaultstyles){var style=document.createElement("style");style.textContent=defaultStyles;document.head.appendChild(style);}this.data.input=document.querySelector(this.data.config.searchinput);if(!this.data.input){throw new Error("Postcoder Autocomplete: No input element found. Please provide a valid query selector for a text input to the searchterm option.")}if(!(this.data.input instanceof HTMLInputElement)){throw new Error("Postcoder Autocomplete: The input element must be an <input> element. Please provide a valid query selector for a text input to the searchterm option.")}this.data.input.classList.add("postcoder-input");this.data.input.setAttribute("type","search");this.data.input.setAttribute("autocomplete","off");this.data.input.setAttribute("autocapitalize","off");this.data.input.setAttribute("autocorrect","off");this.data.input.setAttribute("spellcheck","false");this.data.input.addEventListener("input",function(){return input.call(_this)});this.data.input.addEventListener("focus",function(){return focus.call(_this)});this.data.input.addEventListener("keydown",function(e){return keydown.call(_this,e)});if(!this.data.config.countrycode&&!this.data.config.country){throw new Error("Postcoder Autocomplete: No country code or country selector provided. Please provide a valid ISO 3166-1 alpha-2 code for the country you wish to search or a query selector for a <select> element.")}if(this.data.config.country){this.data.countrySelectorElement=document.querySelector(this.data.config.country);if(!(this.data.countrySelectorElement instanceof HTMLSelectElement)){throw new Error("Postcoder Autocomplete: The country element must be a <select> element. Please provide a valid query selector for a <select> element to the country option.")}}this.setupSuggestionsList();Object.keys(this.data.config.outputfields).forEach(function(key){if(key.startsWith("addressline")){_this.data.addresslines++;}});});window.PostcoderAddressAutocomplete=PostcoderAddressAutocomplete;
