function _classCallCheck(a, n) {
  if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function");
}
function _createClass(e, r, t) {
  return Object.defineProperty(e, "prototype", {
    writable: false
  }), e;
}

var defaultConfig={apikey:"",searchinput:"",outputfields:{addressline1:""},defaultstyles:true,geolocate:false,identifier:"Postcoder Integrator"};var data={abortController:null,addresslines:0,apikey:"",config:Object.assign({},defaultConfig),countrySelectorElement:null,debounce:0,facetselected:false,input:null,inputdelay:300,no_results_message:"No addresses found",pathfilter:"",retrieveEndpoint:"https://ws.postcoder.com/pcw/autocomplete/retrieve",searchterm:"",selectedIndex:-1,suggestionEndpoint:"https://ws.postcoder.com/pcw/autocomplete/find",suggestionlist:null,suggestions:[]};

var selectSuggestion=function selectSuggestion(target){var dataTypeAttribute=target.getAttribute("data-type");var dataIdAttribute=target.getAttribute("data-id");if(dataIdAttribute==null)return;if(dataTypeAttribute==="BACK"){data.facetselected=false;data.pathfilter="";getSuggestions();}else if(dataTypeAttribute==="ADD"){retrieve(dataIdAttribute);}else {data.pathfilter=dataIdAttribute.toString();data.facetselected=true;getSuggestions();}};var showSuggestions=function showSuggestions(){if(!data.suggestionlist){return}data.suggestionlist.style.display="block";if(data.suggestions.length===0){var option=document.createElement("li");option.classList.add("postcoder-suggestion");option.classList.add("postcoder-no-results");option.innerHTML=data.no_results_message;data.suggestionlist.appendChild(option);data.facetselected=false;data.pathfilter="";}else {for(var i=0;i<data.suggestions.length;i++){var _option=document.createElement("li");_option.classList.add("postcoder-suggestion");var suggestiontext="";suggestiontext=data.suggestions[i].summaryline;if(data.suggestions[i].count>1){var count=data.suggestions[i].count>100?"100+":data.suggestions[i].count;suggestiontext+=" <span class=\"postcoder-extra-info\">("+count+" addresses)</span>";}_option.innerHTML=suggestiontext;_option.setAttribute("data-id",data.suggestions[i].id);_option.setAttribute("data-type",data.suggestions[i].type);data.suggestionlist.appendChild(_option);}if(data.facetselected){var backOption=data.suggestionlist.querySelector("li[data-type=\"BACK\"]");if(backOption){return}else {console.log("Adding back option");var _option2=document.createElement("li");_option2.classList.add("postcoder-suggestion");_option2.classList.add("postcoder-facet-back");_option2.innerHTML="\u21A9 Back";_option2.setAttribute("data-type","BACK");_option2.setAttribute("data-id","0");data.suggestionlist.insertBefore(_option2,data.suggestionlist.firstChild);}}}};var retrieve=function retrieve(id){var country=getCountry();var url=data.retrieveEndpoint+"?apikey="+data.apikey+"&country="+country+"&query="+data.searchterm+"&id="+id+"&lines="+data.addresslines+"&identifier="+encodeURIComponent(data.config.identifier)+"&exclude="+excludeFields();fetch(url).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(addresses){processResult(addresses[0]);})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});};var getSuggestions=function getSuggestions(){data.searchterm=encodeURIComponent(data.input.value.trim());if(data.searchterm.length<3){hideSuggestions();return}var url=data.suggestionEndpoint+"?apikey="+data.apikey+"&country="+getCountry()+"&singlesummary=true"+"&query="+data.searchterm;if(data.pathfilter){url+="&pathfilter="+encodeURIComponent(data.pathfilter);}if(data.config.usercategory){url+="&usercategory="+data.config.usercategory;}if(data.config.postcode){url+="&postcode="+data.config.postcode;}if(data.config.enablefacets){url+="&enablefacets="+data.config.enablefacets;}if(data.config.maximumresults){url+="&maximumresults="+data.config.maximumresults;}data.abortController=new AbortController;fetch(url,{signal:data.abortController.signal}).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(json){newSuggestionsReset();data.suggestions=json;showSuggestions();})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});};var hideSuggestions=function hideSuggestions(){if(!data.suggestionlist)return;data.suggestionlist.innerHTML="";data.suggestionlist.style.display="none";};var newSuggestionsReset=function newSuggestionsReset(){hideSuggestions();data.pathfilter="";data.suggestions=[];data.suggestionlist.scrollTop=0;data.selectedIndex=-1;};var getCountry=function getCountry(){return typeof data.config.countrycode!=="undefined"&&data.config.countrycode!==""?data.config.countrycode:data.countrySelectorElement.value};var processResult=function processResult(address){hideSuggestions();data.facetselected=false;newSuggestionsReset();var possibleFields=["organisation","addressline1","addressline2","addressline3","addressline4","addressline5","addressline6","addressline7","addressline8","addressline9","posttown","county","postcode"];for(var i=0;i<possibleFields.length;i++){var field_selector=data.config.outputfields[possibleFields[i]];if(typeof field_selector=="string"&&field_selector!==""){var element=document.querySelector(field_selector);if(element instanceof HTMLInputElement){element.value=typeof address[possibleFields[i]]!=="undefined"?address[possibleFields[i]]:"";}}}};var excludeFields=function excludeFields(){var organisationField=data.config.outputfields["organisation"];if(organisationField===""||organisationField===undefined){return "posttown,county,postcode,country"}else {return "organisation,posttown,county,postcode,country"}};

var suggestionClick=function suggestionClick(event){event.stopPropagation();if(event.target==null||!(event.target instanceof Element)){return}var target=event.target;while(target.tagName.toLowerCase()!=="li"){if(target.parentNode!=null&&target.parentNode instanceof Element){target=target.parentNode;}}selectSuggestion(target);};var documentClick=function documentClick(event){if(!event.target)return;if(data.suggestionlist.contains(event.target)||data.input.contains(event.target)){return}hideSuggestions();};var keydown=function keydown(event){if(!data.suggestionlist)return;var key=event.key;switch(key){case "Up":case "Down":case "ArrowUp":case "ArrowDown":{var selectedIndex=key==="ArrowUp"||key==="Up"?data.selectedIndex-1:data.selectedIndex+1;event.preventDefault();arrows(selectedIndex);break}case "Tab":{tab(event);break}case "Enter":{selectSuggestion(data.suggestionlist.querySelectorAll("li")[data.selectedIndex]);break}case "Esc":case "Escape":{hideSuggestions();break}default:data.facetselected=false;data.pathfilter="";return}};var arrows=function arrows(selectedIndex){if(!data.suggestionlist)return;var suggestionsCount=data.suggestions.length;if(data.suggestionlist.querySelectorAll("li").length>0){if(data.selectedIndex>=0){data.suggestionlist.querySelectorAll("li")[data.selectedIndex].classList.remove("selected");}data.selectedIndex=(selectedIndex%suggestionsCount+suggestionsCount)%suggestionsCount;data.suggestionlist.querySelectorAll("li")[data.selectedIndex].classList.add("selected");data.suggestionlist.querySelectorAll("li")[data.selectedIndex].scrollIntoView(false);}};var tab=function tab(event){if(data.selectedIndex>=0){event.preventDefault();selectSuggestion(data.suggestionlist.querySelectorAll("li")[data.selectedIndex]);}else {hideSuggestions();}};var input=function input(){clearTimeout(data.debounce);if(data.abortController!==null){data.abortController.abort("Aborted a request to Postcoder because new input was detected.");}data.debounce=setTimeout(function(){return getSuggestions()},data.inputdelay);};var focus=function focus(){if(data.suggestions.length>0){showSuggestions();}else {getSuggestions();}};

var defaultStyles = ".postcoder-wrapper{position:relative;width:100%;}.postcoder-wrapper input.postcoder-input{width:100%;}.postcoder-wrapper ul.postcoder-suggestions-list{position:absolute;background-color:white;border:1px solid #ccc;padding:0;max-height:400px;overflow-y:auto;width:100%;z-index:1000;margin:0;display:none;list-style-type:none;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion{cursor:pointer;padding:0.5rem 1rem;}.postcoder-wrapper\rul.postcoder-suggestions-list\rli.postcoder-suggestion.selected{background-color:bisque;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion:hover{background-color:#ddd;}.postcoder-wrapper ul.postcoder-suggestions-list .postcoder-extra-info{font-size:0.8rem;color:#666;}.postcoder-wrapper ul.postcoder-suggestions-list .postcoder-facet-back{font-weight:bold;}";

var PostcoderAddressAutocomplete=_createClass(function PostcoderAddressAutocomplete(config){_classCallCheck(this,PostcoderAddressAutocomplete);this.setupSuggestionsList=function(){if(!data.input)return;var suggestionsElement=document.createElement("ul");suggestionsElement.classList.add("postcoder-suggestions-list");suggestionsElement.addEventListener("click",suggestionClick);var wrapper=document.createElement("div");wrapper.classList.add("postcoder-wrapper");data.input.parentNode.insertBefore(wrapper,data.input.nextSibling);wrapper.appendChild(data.input);wrapper.appendChild(suggestionsElement);document.body.addEventListener("click",documentClick);data.suggestionlist=suggestionsElement;};var mergedConfigs=Object.assign(Object.assign({},data.config),config);data.config=mergedConfigs;data.abortController=null;if(data.config.apikey){data.apikey=data.config.apikey;}else {throw new Error("Postcoder Autocomplete: No API key provided. This is required for address lookup to function. Sign up for a free trial at https://postcoder.com")}if(data.config.defaultstyles){var style=document.createElement("style");style.textContent=defaultStyles;document.head.appendChild(style);}data.input=document.querySelector(data.config.searchinput);if(!data.input){throw new Error("Postcoder Autocomplete: No input element found. Please provide a valid query selector for a text input to the searchterm option.")}if(!(data.input instanceof HTMLInputElement)){throw new Error("Postcoder Autocomplete: The input element must be an <input> element. Please provide a valid query selector for a text input to the searchterm option.")}data.input.classList.add("postcoder-input");data.input.setAttribute("type","search");data.input.setAttribute("autocomplete","off");data.input.setAttribute("autocapitalize","off");data.input.setAttribute("autocorrect","off");data.input.setAttribute("spellcheck","false");data.input.addEventListener("input",input);data.input.addEventListener("focus",focus);data.input.addEventListener("keydown",keydown);if(!data.config.countrycode&&!data.config.country){throw new Error("Postcoder Autocomplete: No country code or country selector provided. Please provide a valid ISO 3166-1 alpha-2 code for the country you wish to search or a query selector for a <select> element.")}if(data.config.country){data.countrySelectorElement=document.querySelector(data.config.country);if(!(data.countrySelectorElement instanceof HTMLSelectElement)){throw new Error("Postcoder Autocomplete: The country element must be a <select> element. Please provide a valid query selector for a <select> element to the country option.")}}this.setupSuggestionsList();Object.keys(data.config.outputfields).forEach(function(key){if(key.startsWith("addressline")){data.addresslines++;}});});window.PostcoderAddressAutocomplete=PostcoderAddressAutocomplete;
